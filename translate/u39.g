#  File converted from Magma code -- requires editing and checking
#  Magma -> GAP converter, version 0.43, 4/04/16 by AH

#  Global Variables used: Append, Centraliser, FPGroupStrong, Generators, Id,
#  Index, IsConjugate, Ngens, Order, Random, RandomProcess, SolubleResidual,
#  Sym, get_standard_gens_u39, homom

#  Defines: U39Identify, get_standard_gens_u39

DeclareGlobalFunction("U39Identify@");

get_standard_gens_u39@:=function(G)
#  /out: standard gens and algorithm that Bill Unger made up 27/5/2004 /out:
#  assumes G is isomorphic to U3(9) 
local P,a,b,ord;
  P:=RandomProcess(G);
  repeat
    b:=Random(P);
    ord:=Order(b);
    
  until ord mod 6=0;
  #   1 in 19
  b:=b^(QuoInt(ord,6));
  #   6A
  a:=b^3;
  #   2A
  repeat
    a:=a^Random(P);
    
  until Order(a*b)=15;
  #   about 1 in 16-17
  return rec(val1:=a,
    val2:=b);
end;
;
InstallGlobalFunction(U39Identify@,
function(group)
local 
   CG,F,M,Print,S,a,au39,aut,b,c,ce,g,ga,gb,group,h,homom,i,ims,isc,j,max,
   maximals,newgens,phi,simp,soc;
  max:=ValueOption("max");
  if max=fail then
    max:=true;
  fi;
  Print:=ValueOption("Print");
  if Print=fail then
    Print:=0;
  fi;
  S:=SymmetricGroup(730);
  a:=(1,419)(2,198)(3,595)(4,430)(5,617)(6,507)(7,116)(8,121)(9,534)(10,427)
   (11,117)(12,584)(13,524)(14,399)(15,630)(16,513)(17,573)(18,705)(19,640)
   (20,66)(21,618)(22,539)(23,718)(24,578)(25,669)(26,421)(28,486)(29,401)
   (30,479)(31,393)(32,154)(33,656)(34,525)(35,428)(36,514)(37,62)(38,243)
   (39,321)(40,444)(41,665)(42,113)(43,608)(44,318)(45,107)(46,86)(47,134)
   (48,606)(49,568)(50,609)(51,662)(52,339)(53,232)(56,489)(57,250)(58,695)
   (59,226)(60,420)(61,484)(63,84)(64,376)(65,624)(67,346)(68,295)(69,219)
   (70,216)(71,157)(72,81)(73,546)(74,306)(75,123)(76,622)(77,189)(78,266)
   (79,101)(80,375)(82,102)(85,223)(87,713)(88,505)(89,466)(90,725)(91,694)
   (92,97)(93,126)(94,449)(95,247)(96,200)(98,162)(99,380)(100,561)(103,523)
   (104,703)(105,641)(106,385)(108,455)(109,433)(110,289)(111,651)(112,208)
   (114,341)(115,478)(118,417)(119,408)(120,458)(122,414)(124,629)(125,309)
   (127,560)(128,330)(129,512)(130,708)(131,650)(132,429)(133,242)(135,328)
   (136,554)(137,698)(138,633)(139,728)(140,331)(141,164)(142,412)(143,654)
   (144,519)(145,390)(146,586)(147,701)(148,528)(149,532)(150,197)(151,391)
   (153,298)(155,672)(156,188)(158,322)(159,238)(160,719)(161,445)(163,316)
   (165,214)(166,469)(167,244)(168,661)(169,174)(170,252)(171,459)(172,612)
   (173,675)(175,682)(176,676)(177,291)(178,382)(179,499)(180,410)(181,397)
   (182,540)(183,334)(184,255)(185,359)(186,712)(187,193)(191,285)(192,620)
   (194,664)(195,463)(196,531)(199,674)(201,454)(202,249)(203,649)(204,555)
   (205,307)(206,363)(207,340)(209,405)(210,229)(211,477)(212,509)(213,659)
   (215,628)(217,688)(218,625)(220,288)(221,460)(222,700)(224,258)(225,297)
   (227,437)(228,338)(230,313)(231,366)(233,273)(234,394)(235,559)(236,349)
   (237,345)(239,333)(240,253)(241,487)(245,631)(246,516)(248,378)(251,355)
   (254,395)(256,259)(257,409)(262,601)(263,440)(264,287)(265,504)(267,327)
   (268,431)(269,632)(270,344)(271,497)(272,663)(274,278)(275,571)(276,611)
   (277,692)(279,686)(280,572)(281,323)(282,635)(283,626)(284,639)(286,456)
   (290,418)(292,536)(293,677)(294,465)(296,653)(299,647)(300,717)(301,549)
   (302,580)(303,434)(304,415)(308,690)(310,587)(311,547)(312,423)(314,347)
   (315,552)(317,358)(319,679)(320,721)(324,671)(325,388)(326,709)(329,475)
   (332,722)(335,567)(336,657)(337,483)(342,392)(343,373)(348,438)(350,357)
   (351,482)(352,702)(353,556)(354,356)(360,510)(361,598)(362,585)(364,623)
   (365,379)(367,543)(368,581)(369,500)(370,443)(371,411)(372,383)(374,511)
   (377,678)(381,602)(384,589)(386,707)(387,615)(389,426)(396,468)(398,461)
   (400,476)(402,521)(403,457)(404,470)(406,488)(407,533)(413,729)(416,535)
   (422,614)(424,436)(425,667)(432,605)(435,714)(439,697)(441,550)(442,451)
   (446,518)(447,652)(448,452)(450,684)(453,542)(462,492)(464,687)(467,520)
   (471,558)(472,680)(473,493)(474,643)(480,553)(481,569)(485,575)(490,537)
   (491,723)(494,681)(495,599)(496,506)(498,642)(502,538)(503,566)(508,594)
   (515,545)(517,596)(522,673)(526,604)(527,590)(529,689)(530,648)(541,706)
   (544,691)(548,726)(551,634)(557,715)(562,577)(563,646)(564,582)(565,668)
   (570,645)(574,693)(576,666)(579,616)(583,627)(588,685)(591,660)(592,638)
   (593,658)(597,716)(600,730)(603,699)(607,696)(610,636)(613,670)(619,724)
   (621,711)(637,710)(644,655)(683,720)(704,727) #CAST S
    ;
  b:=(1,378,709,150,689,294)(2,408,319,121,219,179)(3,38,563,151,321,520)
   (4,435,18,549,467,538)(5,245,228,273,300,140)(6,422,267,338,508,130)
   (7,195,262,551,52,596)(8,540,687,425,529,695)(9,365,700,383,141,643)
   (10,528,329,566,99,386)(11,437,509,486,337,249)(12,60,598,287,234,456)
   (13,493,154,97,29,343)(14,272,580,431,229,728)(15,55,218,710,426,723)
   (16,214,356,253,346,376)(17,587,702,51,411,293)(19,324,86,335,53,396)
   (20,487,461,31,724,302)(21,555,663,35,630,516)(22,354,242,105,333,641)
   (23,559,124,215,239,400)(24,561,484,448,444,495)(25,514,480,577,342,472)
   (26,188,42,547,142,74)(27,371,325,401,33,521)(28,553,675,668,649,560)
   (30,533,421,573,289,557)(32,168,584,611,78,534)(34,539,506,111,238,646)
   (36,58,221,716,373,139)(37,109,634,191,216,581)(39,458,591,603,494,305)
   (40,489,201,112,708,595)(41,71,334,575,145,204)(43,507,545,358,704,567)
   (44,123,526,260,402,531)(45,160,339,286,167,565)(46,157,576,412,443,636)
   (47,570,672,706,169,647)(48,473,360,308,193,586)(49,122,459)
   (50,604,189,680,552,110)(54,357,662,674,691,541)(56,382,471,510,182,692)
   (57,624,722,654,68,389)(59,370,690,197,271,144)(61,517,633,671,203,65)
   (62,645,230,395,453,714)(63,530,104,303,469,275)(64,310,202,166,572,393)
   (66,427,94,701,661,477)(67,583,403,181,457,147)(69,364,257,250,332,278)
   (70,500,206,255,282,261)(72,532,496,254,90,155)(73,415,381,632,637,118)
   (75,119,589,497,81,544)(76,449,688,159,210,93)(77,578,83,328,322,374)
   (79,419,428,676,433,446)(80,156,280,312,666,601)(82,331,288,380,125,482)
   (84,178,318,519,638,209)(85,240,717,217,667,236)(87,499,388,158,379,659)
   (88,208,244,451,416,340)(89,163,173,392,468,184)(91,200,707,306,679,235)
   (92,213,259,247,436,233)(95,460,405,612,134,639)(96,660,434,535,694,719)
   (98,349,194,237,693,454)(100,127,705,615,593,108)(101,656,625,503,609,475)
   (102,397,629,628,274,610)(103,485,406,505,344,276)(106,385,635,246,391,650)
   (107,285,350,429,399,351)(113,558,511,152,414,284)(114,129,548,366,126,251)
   (115,227,715,623,170,465)(116,148,445,153,420,653)(117,536,423,315,165,614)
   (120,606,644,258,605,602)(128,438,301,205,678,725)(131,298,546,703,455,190)
   (132,522,682,183,336,579)(133,664,607,594,211,290)(135,222,441,146,309,568)
   (136,407,283,137,347,492)(138,268,488,525,143,447)(149,515,523,640,418,592)
   (161,466,198)(162,504,474,627,207,618)(164,727,550,387,518,683)
   (171,665,372,685,307,176)(172,491,711,498,648,297)(174,348,697)
   (175,669,462,574,537,562)(177,677,556,681,196,430)(180,375,263,304,281,626)
   (185,440,670,476,452,299)(186,512,730,599,320,417)(187,439,501,199,597,478)
   (192,264,313,554,266,619)(212,686,481,564,590,220)(223,226,241,450,729,613)
   (224,524,326,292,295,369)(225,410,658,616,361,413)(231,432,323,384,265,622)
   (232,721,368,279,655,617)(243,390,270,712,362,330)(248,569,479,317,355,367)
   (252,483,585,394,718,424)(256,571,698,502,311,464)(269,720,542,470,377,588)
   (277,341,352,296,726,463)(291,316,696,409,359,353)(314,673,442,327,631,608)
   (345,651,713,582,642,490)(363,657,699,404,621,527)(398,652,600,543,620,684) 
   #CAST S
    ;
  c:=(1,308,469,256)(2,164,528,57)(3,445,66,335)(4,223,126,608)(5,596,148,322)
   (6,181,729,157)(7,102,178,18)(8,661,65,296)(9,35,426,46)(10,119,685,513)
   (11,279,216,723)(12,90,82,465)(13,642,101,117)(14,703,507,419)
   (15,631,648,168)(16,590,671,113)(17,337,125,295)(19,188,486,396)
   (20,677,570,407)(21,276,466,220)(22,455,320,350)(23,263,504,288)
   (24,636,27,458)(25,36,297,294)(26,720,526,404)(28,718,324,165)
   (29,701,610,423)(30,239,555,412)(31,587,696,74)(32,564,268,468)
   (33,384,595,169)(34,566,289,710)(37,645,434,327)(38,675,302,228)
   (39,638,334,644)(40,689,511,621)(41,179,332,707)(42,568,76,697)
   (43,123,420,599)(44,389,94,144)(45,346,377,247)(47,100,218,542)
   (48,576,340,362)(49,460,713,158)(50,130,367,728)(51,372,244,562)
   (52,214,413,356)(53,171,193,262)(54,374,640,96)(55,620,637,61)(56,241,534,80)
   (58,95,471,212)(59,508,525,79)(60,633,706,686)(63,598,382,624)(64,373)
   (67,569,68,727)(69,550,501,211)(70,338,399,432)(71,479,390,605)
   (72,153,116,365)(73,665,99,516)(75,354,152,142)(77,310,159,98)
   (78,416,524,572)(81,510,197,588)(83,136,405,122)(84,719,456,579)
   (85,255,395,584)(86,490,233,305)(87,589,497,401)(88,208,428,163)
   (89,429,478,232)(91,491,385,567)(92,285,522,659)(93,135,559,191)
   (97,174,155,129)(103,290,475,353)(104,430,124,105)(106,225,626,473)
   (107,238,551,222)(108,662,131,583)(109,560,363,453)(110,442,657,616)
   (111,194,537,408)(112,663,357,418)(114,448,325,398)(115,481,527,251)
   (118,613,205,441)(120,366,309,204)(121,275,712,359)(127,463,274,604)
   (128,162,311,326)(132,488,414,209)(133,175,160,563)(134,655,243,217)
   (137,676,652,392)(138,226,693,539)(139,299,339,252)(140,549,489,619)
   (141,184,240,173)(143,561,406,438)(145,307,500,602)(146,245,545,627)(147,269)
   (149,293,248,242)(150,634,227,577)(151,154,578,688)(156,234,690,593)
   (161,207,190,449)(166,670,502,523)(167,425,601,411)(170,615,192,485)
   (172,666,553,437)(176,329,271,272)(177,342,700,496)(180,273,417,383)
   (182,364,371,393)(183,573,643,544)(185,517,673,499)(186,531,462,582)
   (187,612,546,630)(189,683,349,287)(195,721,609,231)(196,557,391,388)
   (198,236,378,682)(199,452,711,381)(200,585,571,328)(201,258,536,215)
   (202,451,380,552)(203,606,319,446)(206,498,482,521)(210,505,664,457)
   (213,506,674,237)(219,581,259,221)(224,698,647,261)(229,304,495,431)
   (230,679,387,477)(235,519,318,422)(246,436,669,283)(249,654,704,306)
   (250,439,668,680)(253,632,313,424)(257,461,298,459)(260,639,454,554)
   (264,317,316,267)(265,348,575,565)(266,386,705,548)(270,717,474,472)
   (277,286,629,695)(278,580,301,360)(280,358,628,444)(281,592,351,543)
   (282,315,410,487)(284,591,625,529)(291,355,600,352)(292,614,494,480)
   (300,483,687,635)(303,509,470,653)(312,375,341,484)(314,370,556,467)
   (321,646,343,394)(323,597,530,603)(330,651,447,440)(331,684,692,716)
   (333,427,724,702)(336,725,594,345)(344,493,541,656)(347,433,641,538)
   (361,514,476,622)(368,650)(369,660,730,515)(376,532,400,397)(379,617,533,435)
   (402,464,403,618)(409,722,535,672)(415,586,512,558)(421,709,691,503)
   (443,694,450,715)(492,708,623,678)(518,520,649,699)(540,611,726,547)
   (574,658,681,714) #CAST S
    ;
  simp:=SubStructure(S,a,#TODO CLOSURE
    b);
  simp.Order:=42573600;
  # =v= MULTIASSIGN =v=
  phi:=FPGroupStrong(simp);
  F:=phi.val1;
  phi:=phi.val2;
  # =^= MULTIASSIGN =^=
  soc:=SolubleResidual(group);
  aut:=Index(group,soc);
  if Print > 1 then
    Print("group is U(3,9):[%o]\n",aut);
  fi;
  # =v= MULTIASSIGN =v=
  gb:=get_standard_gens_u39@(soc);
  ga:=gb.val1;
  gb:=gb.val2;
  # =^= MULTIASSIGN =^=
  soc:=SubStructure(soc,ga,#TODO CLOSURE
    gb);
  soc.Order:=42573600;
  newgens:=[ga,gb];
  for g in Generators(group) do
    if not g in SubStructure(group,newgens) then
      Add(newgens,g);
    fi;
  od;
  group:=SubStructure(group,newgens);
  au39:=SubStructure(S,a,#TODO CLOSURE
    b,c);
  ims:=[a,b];
  homom:=GroupHomomorphismByImages(soc,simp,
    GeneratorsOfGroup(soc),ims);
  for i in [Ngens(soc)+1..Ngens(group)] do
    g:=group.i;
    CG:=au39;
    ce:=One(au39);
    for j in [1..2] do
      # =v= MULTIASSIGN =v=
      h:=IsConjugate(CG,simp.j^ce,homom(soc.j^g));
      isc:=h.val1;
      h:=h.val2;
      # =^= MULTIASSIGN =^=
      if not isc then
        Error("Conjugation error in Aut(U(3,9))");
      fi;
      CG:=Centraliser(CG,homom(soc.j^g));
      ce:=ce*h;
    od;
    Add(ims,ce);
  od;
  newgens:=ims;
  for g in Generators(au39) do
    if not g in SubStructure(au39,ims) then
      Add(ims,g);
    fi;
  od;
  au39:=SubStructure(S,ims);
  homom:=GroupHomomorphismByImages(group,au39,
    GeneratorsOfGroup(group),newgens);
  maximals:=[];
  if not max then
    return rec(val1:=homom,
      val2:=au39,
      val3:=maximals,
      val4:=F,
      val5:=phi);
  fi;
  #  
  #  Maximal subgroups from ATLAS.
  #  Assuming their list is complete, then all the subgroups below are
  #  maximal subgroups and give one from each conjugacy class
  #  of maximal subgroups.
  
  #   3^(2+4):80 [point stabilizer]
  #   M := BasicStabilizer(simp, 2);
  M:=SubStructure(simp,a,#TODO CLOSURE
    (b*a*b*a*b)^((a*b^-1)^2));
  M.Order:=58320;
  Add(maximals,M);
  #   5 x 2.A6.2_2 [centralizer of inner involution]
  #   M := Centralizer(simp, a);
  M:=SubStructure(simp,a*b^-1*a*b*a,#TODO CLOSURE
    a*b*a*b^-1*a*b^-1*a*b*a*b^2);
  M.Order:=7200;
  Add(maximals,M);
  #   A6:2_2 [centralizer of outer involution]
  #   M := Centralizer(simp, c^2);
  M:=SubStructure(simp,(b*a*b^2*a*b*a*b^-2*a*b^-1)^3,#TODO CLOSURE
    b^3*a*b^-1*a*b^-1*a*b*a*b*a*b^-3,(b^-1*a*b^3*a*b*a*b^-3*a*b)^3);
  M.Order:=720;
  Add(maximals,M);
  #   10^2:S3 [normalizer of a 2^2]
  M:=SubStructure(simp,a,#TODO CLOSURE
    (b^-2*a*b^2*a*b*a*b^-2*a*b^2)^3,b^-1*a*b^3*a*b*a*b^-2*a*b*a*b^-3*a*b^-1);
  M.Order:=600;
  Add(maximals,M);
  #   73:3 [normalizer of Sylow 73-subgroup]
  M:=SubStructure(simp,
   a*b^-1*a*b*a*b^-1*a*b^-1*a*b*a*b^-1*a*b^-2*a*b*a*b^-1*a*b*a,#TODO CLOSURE
    b*a*b*a*b*a*b^-2*a*b^-1*a*b^-2*a*b^-1*a*b^2*a*b^2);
  M.Order:=219;
  Add(maximals,M);
  return rec(val1:=homom,
    val2:=au39,
    val3:=maximals,
    val4:=F,
    val5:=phi);
end);



freeze;

get_standard_gens_u39 := function(G)
/* standard gens and algorithm that Bill Unger made up 27/5/2004 */
/* assumes G is isomorphic to U3(9) */
    P := RandomProcess(G);
    repeat b := Random(P); ord := Order(b); until ord mod 6 eq 0; // 1 in 19
    b := b ^ (ord div 6); // 6A
    a := b ^ 3; // 2A
    repeat a := a^Random(P); until Order(a*b) eq 15; // about 1 in 16-17
    return a,b;
end function;

U39Identify := function(group:max:=true,Print:=0)
S := Sym(730);
a :=S!
\[ 419, 198, 595, 430, 617, 507, 116, 121, 534, 427, 117, 584, 524, 399, 630, 
513, 573, 705, 640, 66, 618, 539, 718, 578, 669, 421, 27, 486, 401, 479, 393, 
154, 656, 525, 428, 514, 62, 243, 321, 444, 665, 113, 608, 318, 107, 86, 134, 
606, 568, 609, 662, 339, 232, 54, 55, 489, 250, 695, 226, 420, 484, 37, 84, 
376, 624, 20, 346, 295, 219, 216, 157, 81, 546, 306, 123, 622, 189, 266, 101, 
375, 72, 102, 83, 63, 223, 46, 713, 505, 466, 725, 694, 97, 126, 449, 247, 200,
92, 162, 380, 561, 79, 82, 523, 703, 641, 385, 45, 455, 433, 289, 651, 208, 42,
341, 478, 7, 11, 417, 408, 458, 8, 414, 75, 629, 309, 93, 560, 330, 512, 708, 
650, 429, 242, 47, 328, 554, 698, 633, 728, 331, 164, 412, 654, 519, 390, 586, 
701, 528, 532, 197, 391, 152, 298, 32, 672, 188, 71, 322, 238, 719, 445, 98, 
316, 141, 214, 469, 244, 661, 174, 252, 459, 612, 675, 169, 682, 676, 291, 382,
499, 410, 397, 540, 334, 255, 359, 712, 193, 156, 77, 190, 285, 620, 187, 664, 
463, 531, 150, 2, 674, 96, 454, 249, 649, 555, 307, 363, 340, 112, 405, 229, 
477, 509, 659, 165, 628, 70, 688, 625, 69, 288, 460, 700, 85, 258, 297, 59, 
437, 338, 210, 313, 366, 53, 273, 394, 559, 349, 345, 159, 333, 253, 487, 133, 
38, 167, 631, 516, 95, 378, 202, 57, 355, 170, 240, 395, 184, 259, 409, 224, 
256, 260, 261, 601, 440, 287, 504, 78, 327, 431, 632, 344, 497, 663, 233, 278, 
571, 611, 692, 274, 686, 572, 323, 635, 626, 639, 191, 456, 264, 220, 110, 418,
177, 536, 677, 465, 68, 653, 225, 153, 647, 717, 549, 580, 434, 415, 305, 74, 
205, 690, 125, 587, 547, 423, 230, 347, 552, 163, 358, 44, 679, 721, 39, 158, 
281, 671, 388, 709, 267, 135, 475, 128, 140, 722, 239, 183, 567, 657, 483, 228,
52, 207, 114, 392, 373, 270, 237, 67, 314, 438, 236, 357, 482, 702, 556, 356, 
251, 354, 350, 317, 185, 510, 598, 585, 206, 623, 379, 231, 543, 581, 500, 443,
411, 383, 343, 511, 80, 64, 678, 248, 365, 99, 602, 178, 372, 589, 106, 707, 
615, 325, 426, 145, 151, 342, 31, 234, 254, 468, 181, 461, 14, 476, 29, 521, 
457, 470, 209, 488, 533, 119, 257, 180, 371, 142, 729, 122, 304, 535, 118, 290,
1, 60, 26, 614, 312, 436, 667, 389, 10, 35, 132, 4, 268, 605, 109, 303, 714, 
424, 227, 348, 697, 263, 550, 451, 370, 40, 161, 518, 652, 452, 94, 684, 442, 
448, 542, 201, 108, 286, 403, 120, 171, 221, 398, 492, 195, 687, 294, 89, 520, 
396, 166, 404, 558, 680, 493, 643, 329, 400, 211, 115, 30, 553, 569, 351, 337, 
61, 575, 28, 241, 406, 56, 537, 723, 462, 473, 681, 599, 506, 271, 642, 179, 
369, 501, 538, 566, 265, 88, 496, 6, 594, 212, 360, 374, 129, 16, 36, 545, 246,
596, 446, 144, 467, 402, 673, 103, 13, 34, 604, 590, 148, 689, 648, 196, 149, 
407, 9, 416, 292, 490, 502, 22, 182, 706, 453, 367, 691, 515, 73, 311, 726, 
301, 441, 634, 315, 480, 136, 204, 353, 715, 471, 235, 127, 100, 577, 646, 582,
668, 503, 335, 49, 481, 645, 275, 280, 17, 693, 485, 666, 562, 24, 616, 302, 
368, 564, 627, 12, 362, 146, 310, 685, 384, 527, 660, 638, 658, 508, 3, 517, 
716, 361, 495, 730, 262, 381, 699, 526, 432, 48, 696, 43, 50, 636, 276, 172, 
670, 422, 387, 579, 5, 21, 724, 192, 711, 76, 364, 65, 218, 283, 583, 215, 124,
15, 245, 269, 138, 551, 282, 610, 710, 592, 284, 19, 105, 498, 474, 655, 570, 
563, 299, 530, 203, 131, 111, 447, 296, 143, 644, 33, 336, 593, 213, 591, 168, 
51, 272, 194, 41, 576, 425, 565, 25, 613, 324, 155, 522, 199, 173, 176, 293, 
377, 319, 472, 494, 175, 720, 450, 588, 279, 464, 217, 529, 308, 544, 277, 574,
91, 58, 607, 439, 137, 603, 222, 147, 352, 104, 727, 18, 541, 386, 130, 326, 
637, 621, 186, 87, 435, 557, 597, 300, 23, 160, 683, 320, 332, 491, 619, 90, 
548, 704, 139, 413, 600 ];
b:= S!
\[ 378, 408, 38, 435, 245, 422, 195, 540, 365, 528, 437, 60, 493, 272, 55, 214, 
587, 549, 324, 487, 555, 354, 559, 561, 514, 188, 371, 553, 343, 533, 724, 168,
521, 539, 630, 58, 109, 563, 458, 489, 71, 547, 507, 123, 160, 157, 570, 473, 
122, 604, 411, 596, 396, 357, 218, 382, 624, 221, 370, 598, 517, 645, 530, 310,
61, 427, 583, 389, 364, 500, 334, 532, 415, 26, 119, 449, 578, 534, 419, 156, 
544, 331, 328, 178, 240, 335, 499, 208, 163, 155, 200, 213, 76, 701, 460, 660, 
29, 349, 386, 127, 656, 397, 485, 303, 333, 385, 285, 100, 634, 50, 238, 708, 
558, 129, 227, 148, 536, 73, 589, 606, 219, 459, 526, 215, 482, 251, 705, 438, 
548, 6, 298, 522, 664, 639, 222, 407, 347, 268, 36, 5, 643, 74, 447, 59, 204, 
309, 67, 445, 515, 689, 321, 414, 420, 97, 72, 280, 576, 379, 210, 339, 466, 
504, 173, 727, 614, 572, 565, 584, 647, 465, 665, 491, 392, 348, 669, 171, 677,
318, 2, 375, 457, 692, 336, 89, 440, 512, 439, 42, 680, 131, 216, 264, 586, 
237, 262, 430, 271, 161, 597, 707, 112, 166, 65, 41, 678, 255, 618, 244, 84, 
93, 290, 686, 259, 356, 239, 581, 667, 710, 179, 212, 716, 441, 226, 524, 410, 
241, 715, 273, 728, 395, 432, 721, 92, 456, 91, 85, 693, 646, 400, 717, 450, 
105, 390, 451, 228, 391, 436, 569, 11, 332, 114, 483, 346, 90, 282, 571, 250, 
605, 247, 402, 70, 551, 304, 313, 622, 619, 338, 488, 720, 712, 144, 580, 300, 
610, 63, 103, 341, 69, 655, 312, 626, 261, 137, 113, 350, 167, 234, 380, 557, 
133, 316, 295, 17, 1, 369, 726, 172, 546, 185, 140, 205, 20, 469, 281, 39, 679,
176, 193, 568, 202, 464, 666, 554, 673, 165, 696, 355, 519, 121, 417, 520, 374,
384, 86, 401, 292, 631, 322, 566, 243, 288, 278, 641, 575, 53, 579, 249, 508, 
286, 88, 352, 472, 13, 276, 651, 376, 492, 697, 194, 429, 107, 296, 291, 242, 
367, 253, 662, 704, 353, 308, 413, 330, 657, 257, 700, 126, 248, 279, 224, 690,
325, 685, 139, 77, 263, 16, 588, 709, 659, 125, 632, 471, 141, 265, 635, 10, 
518, 158, 57, 270, 650, 468, 64, 718, 453, 19, 629, 652, 351, 23, 33, 531, 181,
621, 612, 505, 283, 319, 359, 658, 293, 443, 225, 284, 381, 340, 186, 592, 428,
653, 573, 267, 315, 252, 529, 723, 94, 676, 399, 177, 229, 323, 446, 535, 18, 
233, 509, 301, 501, 670, 146, 327, 636, 495, 153, 79, 138, 444, 688, 729, 416, 
299, 714, 98, 190, 12, 147, 591, 49, 405, 31, 574, 277, 256, 115, 198, 538, 
184, 275, 377, 510, 25, 360, 627, 101, 452, 66, 187, 317, 577, 564, 82, 585, 
448, 406, 337, 461, 525, 201, 345, 711, 136, 154, 305, 24, 254, 81, 648, 388, 
206, 199, 311, 609, 474, 344, 111, 545, 130, 486, 182, 152, 730, 513, 480, 523,
21, 633, 683, 638, 3, 27, 682, 640, 326, 143, 260, 363, 329, 695, 104, 44, 496,
421, 32, 694, 423, 562, 4, 506, 687, 54, 470, 620, 75, 358, 703, 142, 366, 467,
387, 52, 110, 675, 266, 663, 681, 30, 511, 124, 28, 484, 175, 151, 590, 45, 99,
43, 135, 479, 672, 698, 393, 289, 537, 145, 412, 342, 83, 132, 431, 37, 642, 
403, 611, 394, 48, 702, 269, 497, 220, 603, 149, 108, 211, 40, 7, 478, 287, 
320, 543, 80, 120, 494, 189, 602, 644, 594, 314, 475, 102, 78, 134, 223, 117, 
593, 361, 232, 162, 192, 684, 527, 231, 170, 722, 503, 180, 207, 274, 628, 516,
608, 637, 671, 191, 246, 46, 118, 209, 95, 418, 22, 490, 9, 258, 230, 34, 47, 
297, 560, 106, 713, 600, 116, 68, 617, 625, 699, 616, 87, 434, 477, 674, 35, 
607, 372, 601, 236, 649, 462, 476, 203, 706, 442, 691, 668, 433, 556, 725, 235,
552, 196, 183, 164, 398, 307, 481, 425, 159, 294, 197, 541, 56, 454, 719, 8, 
409, 174, 502, 404, 383, 661, 51, 455, 567, 615, 169, 306, 595, 150, 426, 498, 
362, 582, 62, 623, 373, 217, 424, 96, 542, 368, 654, 15, 302, 128, 463, 550, 
14, 613, 599 ];
c := S!
\[ 308, 164, 445, 223, 596, 181, 102, 661, 35, 119, 279, 90, 642, 703, 631, 590,
337, 7, 188, 677, 276, 455, 263, 636, 36, 720, 458, 718, 701, 239, 587, 564, 
384, 566, 426, 297, 645, 675, 638, 689, 179, 568, 123, 389, 346, 9, 100, 576, 
460, 130, 372, 214, 171, 374, 620, 241, 2, 95, 508, 633, 55, 62, 598, 373, 296,
335, 569, 727, 550, 338, 479, 153, 665, 31, 354, 697, 310, 416, 59, 56, 510, 
465, 136, 719, 255, 490, 589, 208, 429, 82, 491, 285, 135, 144, 471, 54, 174, 
77, 516, 218, 117, 178, 290, 430, 104, 225, 238, 662, 560, 442, 194, 663, 16, 
448, 481, 365, 13, 613, 685, 366, 275, 83, 420, 105, 295, 608, 463, 162, 97, 
367, 583, 488, 175, 655, 559, 405, 676, 226, 299, 549, 184, 75, 561, 44, 307, 
245, 269, 322, 293, 634, 154, 142, 116, 578, 129, 234, 6, 49, 98, 563, 207, 
311, 88, 528, 28, 670, 425, 15, 33, 615, 193, 666, 141, 155, 160, 329, 342, 18,
332, 273, 729, 364, 573, 240, 517, 531, 612, 486, 683, 449, 93, 485, 262, 537, 
721, 557, 588, 236, 452, 585, 258, 451, 606, 120, 441, 498, 190, 428, 132, 505,
69, 58, 506, 413, 201, 723, 134, 542, 581, 21, 219, 107, 126, 698, 626, 693, 
577, 38, 304, 679, 195, 89, 305, 690, 519, 378, 213, 551, 555, 173, 534, 149, 
217, 562, 545, 436, 45, 242, 654, 439, 115, 139, 632, 254, 395, 1, 461, 536, 
221, 639, 224, 53, 504, 317, 348, 386, 264, 468, 147, 717, 272, 176, 417, 604, 
712, 466, 286, 580, 216, 358, 592, 315, 246, 591, 522, 629, 189, 23, 710, 475, 
355, 614, 248, 25, 17, 8, 294, 459, 339, 483, 360, 228, 509, 495, 86, 249, 500,
469, 204, 159, 326, 375, 424, 370, 410, 267, 316, 422, 446, 350, 646, 5, 597, 
165, 398, 128, 37, 200, 271, 651, 684, 707, 427, 644, 3, 725, 125, 399, 252, 
362, 484, 700, 394, 493, 336, 377, 433, 575, 287, 22, 543, 291, 103, 152, 600, 
52, 418, 628, 121, 278, 514, 48, 453, 371, 72, 309, 728, 650, 660, 556, 393, 
244, 64, 640, 341, 532, 247, 682, 617, 552, 199, 624, 180, 595, 567, 705, 477, 
196, 94, 605, 388, 137, 182, 321, 584, 19, 376, 114, 432, 397, 87, 464, 618, 
26, 122, 438, 20, 111, 722, 487, 167, 30, 356, 209, 586, 524, 383, 112, 14, 
599, 709, 235, 29, 253, 601, 46, 724, 163, 478, 124, 229, 70, 641, 327, 379, 
669, 172, 143, 668, 330, 118, 657, 694, 280, 66, 203, 440, 325, 161, 715, 380, 
711, 109, 554, 320, 579, 210, 24, 257, 713, 298, 582, 274, 403, 12, 220, 314, 
32, 256, 653, 212, 270, 106, 472, 353, 622, 230, 232, 390, 292, 527, 521, 687, 
312, 170, 396, 282, 414, 619, 233, 385, 708, 541, 480, 431, 177, 401, 482, 185,
602, 211, 523, 421, 288, 664, 674, 419, 525, 470, 197, 621, 558, 10, 476, 369, 
73, 673, 520, 318, 649, 206, 659, 166, 572, 79, 404, 251, 57, 284, 603, 462, 
400, 435, 80, 672, 215, 408, 347, 138, 611, 656, 47, 281, 183, 627, 630, 540, 
266, 489, 501, 222, 202, 437, 260, 412, 467, 391, 415, 191, 363, 406, 51, 133, 
268, 265, 289, 91, 76, 68, 407, 328, 78, 643, 658, 565, 340, 150, 688, 84, 301,
259, 186, 108, 85, 571, 512, 696, 81, 497, 671, 625, 351, 156, 345, 169, 148, 
530, 382, 43, 352, 411, 145, 323, 127, 71, 319, 607, 4, 231, 423, 726, 546, 
205, 494, 192, 110, 533, 402, 140, 637, 40, 361, 678, 63, 529, 473, 146, 444, 
695, 187, 648, 313, 706, 227, 300, 27, 61, 334, 454, 96, 538, 101, 544, 39, 
434, 343, 261, 168, 699, 368, 447, 392, 303, 704, 243, 344, 616, 681, 92, 730, 
65, 131, 357, 457, 99, 553, 667, 680, 283, 502, 113, 409, 499, 237, 302, 652, 
570, 492, 387, 250, 714, 198, 349, 692, 513, 60, 635, 151, 511, 593, 503, 716, 
539, 450, 277, 74, 42, 647, 518, 496, 610, 333, 507, 306, 548, 686, 41, 623, 
691, 34, 381, 359, 158, 574, 443, 331, 474, 324, 456, 526, 609, 535, 11, 702, 
594, 547, 67, 50, 157, 515 ];

    simp := sub<S|a,b>;
    simp`Order := 42573600;
    F, phi := FPGroupStrong(simp);
    soc := SolubleResidual(group);
    aut := Index(group, soc);
    if Print gt 1 then printf "group is U(3,9):[%o]\n", aut; end if;
    ga, gb:= get_standard_gens_u39(soc);
    soc := sub< soc | ga,gb >;
    soc`Order := 42573600;
    newgens := [ group | ga, gb];
    for g in Generators(group) do
       if not g in sub<group|newgens> then Append(~newgens,g); end if;
    end for;
    group := sub<group|newgens>;
    au39 := sub< S | a, b, c >;
    ims := [ au39 | a, b];
    homom :=  hom< soc -> simp | ims >;
    for i in [Ngens(soc)+1..Ngens(group)] do
        g := group.i;
        CG := au39; ce := Id(au39);
        for j in [1..2] do
            isc, h := IsConjugate(CG,simp.j^ce,homom(soc.j^g));
            if not isc then error "Conjugation error in Aut(U(3,9))"; end if;
            CG := Centraliser(CG,homom(soc.j^g));
            ce := ce*h;
        end for;
        Append(~ims,ce);
    end for;
    newgens := ims;
    for g in Generators(au39) do
        if not g in sub<au39|ims> then Append(~ims,g); end if;
    end for;
    au39 := sub< S | ims >;
    homom :=  hom< group -> au39 | newgens >;

    maximals:= [];
    if not max then 
        return homom, au39, maximals, F, phi;
    end if;
    
    /* 
       Maximal subgroups from ATLAS.
       Assuming their list is complete, then all the subgroups below are
       maximal subgroups and give one from each conjugacy class
       of maximal subgroups.
    */ 

    // 3^(2+4):80 [point stabilizer]
    // M := BasicStabilizer(simp, 2);
    M := sub<simp| a, (b * a * b * a * b) ^ ((a * b^-1)^2) >;
    M`Order := 58320;
    Append(~maximals, M); 

    // 5 x 2.A6.2_2 [centralizer of inner involution] 
    // M := Centralizer(simp, a);
    M := sub<simp|
	a * b^-1 * a * b * a, 
	a * b * a * b^-1 * a * b^-1 * a * b * a * b^2 >;
    M`Order := 7200;
    Append(~maximals, M); 

    // A6:2_2 [centralizer of outer involution]
    // M := Centralizer(simp, c^2);
    M := sub<simp|
	(b * a * b^2 * a * b * a * b^-2 * a * b^-1)^3, 
	b^3 * a * b^-1 * a * b^-1 * a * b * a * b * a * b^-3, 
	(b^-1 * a * b^3 * a * b * a * b^-3 * a * b)^3 >;
    M`Order := 720;
    Append(~maximals, M); 
    
    // 10^2:S3 [normalizer of a 2^2]
    M := sub< simp |
	a, (b^-2 * a * b^2 * a * b * a * b^-2 * a * b^2)^3, 
	b^-1 * a * b^3 * a * b * a * b^-2 * a * b * a * b^-3 * a * b^-1 >;
    M`Order := 600;
    Append(~maximals, M); 

    // 73:3 [normalizer of Sylow 73-subgroup]
    M := sub<simp |
	a * b^-1 * a * b * a * b^-1 * a * b^-1 * a * b * a * b^-1 * a * 
	    b^-2 * a * b * a * b^-1 * a * b * a, 
	b * a * b * a * b * a * b^-2 * a * b^-1 * a * b^-2 * a * b^-1 * 
	    a * b^2 * a * b^2 >;
    M`Order := 219;
    Append(~maximals, M); 

    return homom, au39, maximals, F, phi;
end function;
